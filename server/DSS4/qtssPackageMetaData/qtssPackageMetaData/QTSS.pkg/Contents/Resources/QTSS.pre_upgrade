#!/bin/sh
#
#
PATH=/usr/bin:/bin
export PATH

echo "pre_upgrade"

# first mv any existing 3.x files to a backup name
mv -f "${3}/etc/streaming/streamingserver.xml" "${3}/tmp/streamingserver.xml.backup"
mv -f "${3}/etc/streaming/streamingrelay.conf" "${3}/tmp/streamingrelay.conf.backup"
mv -f "${3}/etc/streaming/streamingadminserver.conf" "${3}/tmp/streamingadminserver.conf.backup"
mv -f "${3}/etc/streaming/streamingadminserver_autostart.conf" "${3}/tmp/streamingadminserver_autostart.conf.backup"
mv -f "${3}/etc/streaming/qtusers" "${3}/tmp/qtusers.backup"
mv -f "${3}/etc/streaming/qtgroups" "${3}/tmp/qtgroups.backup"
mv -f "${3}/etc/streaming/streamingloadtool.conf" "${3}/tmp/streamingloadtool.conf.backup"
mv -f "${3}/etc/streaming/streamingadminserver.pem" "${3}/tmp/streamingadminserver.pem.backup"

# backup any new config files and overwrite any older files
mv -f "${3}/Library/QuickTimeStreaming/Config/streamingserver.xml" "${3}/tmp/streamingserver.xml.backup"
mv -f "${3}/Library/QuickTimeStreaming/Config/streamingserver.xml-sample" "${3}/tmp/streamingserver.xml-sample.backup"
mv -f "${3}/Library/QuickTimeStreaming/Config/streamingrelay.conf" "${3}/tmp/streamingrelay.conf.backup"
mv -f "${3}/Library/QuickTimeStreaming/Config/relayconfig.xml" "${3}/tmp/relayconfig.xml.backup"
mv -f "${3}/Library/QuickTimeStreaming/Config/streamingadminserver.conf" "${3}/tmp/streamingadminserver.conf.backup"
mv -f "${3}/Library/QuickTimeStreaming/Config/streamingadminserver_autostart.conf" "${3}/tmp/streamingadminserver_autostart.conf.backup"
mv -f "${3}/Library/QuickTimeStreaming/Config/qtusers" "${3}/tmp/qtusers.backup"
mv -f "${3}/Library/QuickTimeStreaming/Config/qtgroups" "${3}/tmp/qtgroups.backup"
mv -f "${3}/Library/QuickTimeStreaming/Config/streamingloadtool.conf" "${3}/tmp/streamingloadtool.conf.backup"
mv -f "${3}/Library/QuickTimeStreaming/Config/streamingadminserver.pem" "${3}/tmp/streamingadminserver.pem.backup"

#kill any running QTSS servers
ps -ax | awk '{print $1" " $5}' | awk '/QuickTimeStreamingServer/ {print $1}' | xargs kill -9  
ps -ax | awk '/streamingadminserver.pl/ {print $0}' | awk '/perl/ {print $1}' |  xargs kill -9  

exit 0
