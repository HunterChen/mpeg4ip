<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
<head>
  <meta http-equiv="content-type"
 content="text/html; charset=ISO-8859-1">
  <title>Building mpeg4ip with V4L2 support</title>
</head>
<body>
<div style="text-align: center;">
<h1>Building mpeg4ip with V4L2 support</h1></div>
<p>
January, 2004<br>
Bill May<br>
Original version by Waqar Mohsin<br>
<p>
<a href="#rh">Building on Redhat 9</a><br>
<a href="#suse">Adding 2.6.1 Kernel to SuSE 9.0</a><br>

<div id="rh">
<h2>A. Redhat Linux 9 Installation</h2>
</div>
<p>
This section only applies if you setting up a machine from scratch.<br>
If not, go <a href="#build1">here</a>
<br>
Pick the <span style="font-style: italic;">custom install</span>
option.<br>
<h3>1. Package Group Selection</h3>
<table cellpadding="2" cellspacing="2" border="1"
 style="text-align: left; height: 383px; width: 513px;">
  <tbody>
    <tr>
      <td
 style="vertical-align: top; background-color: rgb(192, 192, 192);">Package
Name<br>
      </td>
      <td
 style="vertical-align: top; background-color: rgb(192, 192, 192);">Selected<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">X Window System<br>
      </td>
      <td style="vertical-align: top;">31/33<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">GNOME<br>
      </td>
      <td style="vertical-align: top;">35/35<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">KDE<br>
      </td>
      <td style="vertical-align: top;">14/16<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Editors<br>
      </td>
      <td style="vertical-align: top;">2/4<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Graphical Internet<br>
      </td>
      <td style="vertical-align: top;">8/14<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Sound and Video<br>
      </td>
      <td style="vertical-align: top;">14/19<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Graphics<br>
      </td>
      <td style="vertical-align: top;">10/13<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Server Configuration Tools<br>
      </td>
      <td style="vertical-align: top;">9/13<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Web Server<br>
      </td>
      <td style="vertical-align: top;">12/17<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Development Tools<br>
      </td>
      <td style="vertical-align: top;">35/46<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Kernel Development<br>
      </td>
      <td style="vertical-align: top;">4/4<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">X Software Development<br>
      </td>
      <td style="vertical-align: top;">18/18<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">GNOME Software Development<br>
      </td>
      <td style="vertical-align: top;">42/48<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Administration Tools<br>
      </td>
      <td style="vertical-align: top;">11/11<br>
      </td>
    </tr>
  </tbody>
</table>
<p>
<div id="build1">
<h3>2. Build a Custom Kernel</h3></div>
<p>
The instructions are given in <a
 href="http://www.redhat.com/docs/manuals/linux/RHL-9-Manual/custom-guide/ch-custom-kernel.html">Redhat
Linux 9 Customization Guide</a>. You must have the kernel source installed before continuing<br>
<ol>
  <li>Open a terminal.</li>
  <li><code>su -</code></li>
  <li><code>cd /usr/src/linux-2.4</code></li>
  <li><code>make mrproper</code></li>
  <li><code>cp config/kernel-2.4.20-i686.config .config</code></li>
  <li><code>make xconfig</code></li>
  <li>This will bring up the Linux Kernel Configuration window. Just
click <span style="font-style: italic;">Save and Exit</span>.</li>
  <li><code>make clean</code></li>
  <li><code>make bzImage</code></li>
  <li><code>make modules</code></li>
  <li><code>make modules_install</code></li>
  <li><code>make install</code></li>
  <li>Verify that <code>/boot/initrd-2.4.20-8custom.img</code> exists</li>
  <li><code>reboot</code></li>
</ol>
<p>
<h3>3. Install V4L2</h3>
<p>
V4L2 is a work in progress. So far, I've only gotten the 20030717 CVS
snapshot to work.<p>
You should read the directions from the V4L2 web site - they only apply for the
versions that we've specified.<br>
<ol>
  <li>Download <code>v4l2-20030717.tar.gz</code>
to the home directory</li>
  <li><code>tar xvfz v4l2-20030717.tar.gz</code></li>
  <li>su</li>
  <li><code>cd v4l2</code></li>
  <li><span style="font-family: monospace;"></span><code>mv
/usr/include/linux/videodev.h /usr/include/linux/videodev.h.orig</code><code></code></li>
  <li><code>cp videodev.h /usr/include/linux</code><code></code></li>
  <li><code>cp videodev2.h /usr/include/linux</code></li>
  <li>Edit <code>Makefile</code> and change <code>depmod</code> to <code>/sbin/depmod</code></li>
  <li><code>make</code></li>
  <li><code>make install</code></li>
</ol>
<h3>4. Install New bttv Driver</h3>
<ol>
  <li>Download <code>bttv9-20030717.tar.gz</code>
to the home directory</li>
  <li><code>tar xvfz bttv9-20030717.tar.gz</code><code></code></li>
  <li>su</li>
  <li><code>cd bttv-0.9.12<br>
    </code></li>
  <li>Edit <code>Makefile</code> and change <code>depmod</code> to <code>/sbin/depmod</code></li>
  <li><code>make</code></li>
  <li><code>make install</code></li>
</ol>
<h3>5. Setup modprobe to load bttv from new location</h3>
<p>
The V4L2 and bttv drivers are installed in the
/lib/modules/2.4.20-8custom/v4l2 directory. You should see a listing
similar to this:<br>
<br>
<code>-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4936 Aug&nbsp; 4
18:54 btcx-risc.o<br>
-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 113484 Aug&nbsp; 4 18:54 bttv.o<br>
-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 15616 Jul 18 10:48
v4l1-compat.o<br>
-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;y&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8084 Jul 18 10:48
v4l2-common.o<br>
-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 19544 Aug&nbsp; 4 18:54
video-buf.o</code><br>
<br>
The original V4L2 and bttv drivers are installed in
/lib/modules/2.4.20-8custom/kernel/drivers/media/video.<br>
<br>
<span style="font-weight: bold;">modprobe</span> is a program which
loads/unloads <span style="font-style: italic;">loadable kernel modules</span>
(LKMs). By default, modprobe searches for an LKM in /lib/modules/boot
before looking in /lib/modules/2.4.20-8custom. This can be verified by
using the '<code>modprobe -c</code>' command. modprobe also uses
/lib/modules/2.4.20-8custom/modules.dep for resolving module
dependencies.<br>
<br>
The bttv driver installation does not remove the original bttv.o entry
from the modules.dep file (bug ???). Since we want to load the bttv
driver (and its dependencies) from the new location
(/lib/modules/2.4.20-8custom/v4l2 directory), an easy way is to rename
the original bttv LKM and remove its entry from the modules.dep file.
We recommend removing all bttv.o files.  Do a <code>find . -name bttv.o -print</code> and make sure all copies of bttv.o are purged.
The following steps do that:<br>
<ol>
  <li><code>cd /lib/modules/2.4.20-8custom/kernel/drivers/media/video</code></li>
  <li><code>mv bttv.o bttv.o.orig</code> &nbsp&nbsp(We recommend <code>rm bttv.o</code>)</li>
  <li><code>cd /lib/modules/2.4.20-8custom</code></li>
  <li>Edit <code>modules.dep</code> and delete <code>/lib/modules/2.4.20-8custom/kernel/drivers/media/video/bttv.o</code>
and its dependencies.</li>
  <li>Reboot and select the custom kernel when the kernel load screen appears.  Alternatively, change /etc/grub.conf to indicate a default of 0 (that will be the custom kernel you created, and will automatically select it when you reboot).<br>
  </li>
</ol>
<p>
Do a find to make sure that you've overwritten all bttv.o files.
<h3>6. Testing the Installation</h3>
<ul>
  <li><code>su -</code></li>
  <li><code>modprobe bttv</code></li>
  <li><code>modinfo bttv</code> should display something like<br>
  </li>
</ul>
<p>
<code>filename:&nbsp;&nbsp;&nbsp;
/lib/modules/2.4.20-8custom/v4l2/bttv.o<br>
description: "bttv - v4l/v4l2 driver module for bt848/878 based cards"<br>
author:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Ralph Metzler &amp; Marcus
Metzler &amp; Gerd Knorr"<br>
license:&nbsp;&nbsp;&nbsp;&nbsp; "GPL"<br>
...<br>
</code>
<ul>
  <li><code>modinfo v4l2-common</code> should display something like</li>
</ul>
<p>
<code>filename:&nbsp;&nbsp;&nbsp;
/lib/modules/2.4.20-8custom/v4l2/v4l2-common.o<br>
description: "misc helper functions for v4l2 device drivers"<br>
author:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Bill Dirks, Justin Schoeman,
Gerd Knorr"<br>
license:&nbsp;&nbsp;&nbsp;&nbsp; "GPL"</code><br>
<big></big>
<div id="suse">
<h2>B. SuSE 9.0 Installation of 2.6.1 kernel</h2></div>
<p>
This section describes what I did when updating SuSE to a 2.6.1 kernel with
V4L2 support.  I'm not 100% happy with the results (it seems to return the
default settings for the audio, which on my machine is muted, and microphone
off), but it appears to work.
<p>
Note: I did not use the 2.6 test kernel sources that come with SuSE 9.0.
<p>
First, see the instructions on what RPMs are needed for SuSE 9.0 PRO in 
the main readme.
<p>
<ul>
<li>First, download the 2.6.1 kernel. Untar it.</li>
<li>Next, download the v4l2 patches.  I used the 2.6.1rc3 patch. Patch them into the kernel source </li>
<li>You'll have to make a minor change to kernel/exit.c.  You'll have to add
<code>EXPORT_SYMBOL(__set_special_pids);</code> and <code>EXPORT_SYMBOL(set_special_pids);</code> before the function calls.</li>
<li>Configure the kernel.  You can use make oldconfig.  Make sure that you 
enable OSS (it says deprecated, but I was not able to get the ALSA OSS 
compatibility layer to work, so I needed it).</li>
<li>Build the kernel.<code>make;make modules</code></li>
<li>Download and untar the bttv driver.  I used 0.9.12.</li>
<li>Make the bttv driver <code>make KDIR=</code><i>kernel source directory</i></li>
<li>Install the kernel.  <code>make install; make modules_install</code></li>
<li>Install the bttv driver <code>make install</code></li>
<li>Add the kernel to lilo or grub</li>
</ul>
<p>
At this point, you may have a bootable kernel.  I, on the other hand, did not.  It appeared not to load any of the modules for the PCI slots.
<P>
This was the difficult part.  I went to the /etc directory, and used the <code>generate-modprobe.conf
</code> command to generate a new modprobe.conf.  Then I had to add command to install eth0, eth1 and 
the bttv driver.  I also had to remove the snd_ prefixes from the options for snd-emu10k1 and options snd:
<p>
Here's the diff that I had to make after the <code>generate-modprobe.conf</code>:<br>
<code> 
< options snd-emu10k1 snd_enable=1 snd_index=0 <br>
< options snd snd_cards_limit=1 snd_major=116 <br>
---<br>
> options snd-emu10k1 enable=1 index=0<br>
> options snd cards_limit=1 major=116<br>
217a218,221<br>
> install eth0 /bin/true<br>
> install eth1 /bin/true<br>
> install bttv /sbin/modprobe --ignore-install bttv && { /sbin/modprobe -k tuner; /sbin/modprobe -k msp3400; } <br>
</code>
<p>
Good luck.
<p>
<a href="http://validator.w3.org/check/referer"><img
   src="http://www.w3.org/Icons/valid-html401"
   alt="Valid HTML 4.01!" height="31" width="88"></a>
 </p>
</body>
</html>
