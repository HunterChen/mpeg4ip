<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta http-equiv="content-type"
 content="text/html; charset=ISO-8859-1">
  <title>Building mpeg4ip with V4L2 support</title>
</head>
<body>
<div style="text-align: center;">
<h1>Building mpeg4ip with V4L2 support<br>
</h1>
</div>
<h2>A. Redhat Linux 9 Installation</h2>
This section only applies if you setting up a machine from scratch.<br>
<br>
Pick the <span style="font-style: italic;">custom install</span>
option.<br>
<h4>Package Group Selection</h4>
<table cellpadding="2" cellspacing="2" border="1"
 style="text-align: left; height: 383px; width: 513px;">
  <tbody>
    <tr>
      <td
 style="vertical-align: top; background-color: rgb(192, 192, 192);">Package
Name<br>
      </td>
      <td
 style="vertical-align: top; background-color: rgb(192, 192, 192);">Selected<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">X Window System<br>
      </td>
      <td style="vertical-align: top;">31/33<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">GNOME<br>
      </td>
      <td style="vertical-align: top;">35/35<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">KDE<br>
      </td>
      <td style="vertical-align: top;">14/16<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Editors<br>
      </td>
      <td style="vertical-align: top;">2/4<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Graphical Internet<br>
      </td>
      <td style="vertical-align: top;">8/14<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Sound and Video<br>
      </td>
      <td style="vertical-align: top;">14/19<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Graphics<br>
      </td>
      <td style="vertical-align: top;">10/13<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Server Configuration Tools<br>
      </td>
      <td style="vertical-align: top;">9/13<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Web Server<br>
      </td>
      <td style="vertical-align: top;">12/17<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Development Tools<br>
      </td>
      <td style="vertical-align: top;">35/46<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Kernel Development<br>
      </td>
      <td style="vertical-align: top;">4/4<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">X Software Development<br>
      </td>
      <td style="vertical-align: top;">18/18<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">GNOME Software Development<br>
      </td>
      <td style="vertical-align: top;">42/48<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Administration Tools<br>
      </td>
      <td style="vertical-align: top;">11/11<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<h4>Install LAME</h4>
<ol>
  <li>Go to <a href="http://rpmfind.net">http://rpmfind.net</a></li>
  <li>Search for <span style="font-style: italic;">lame</span> and <span
 style="font-style: italic;">lame-devel</span> and download the RPMs to
the home directory. I downloaded <code>lame-3.93.1-fr2.i386.rpm</code>
and <code>lame-devel-3.93.1-fr2.i386.rpm</code>.<br>
  </li>
  <li><code>su<br>
    </code></li>
  <li><code>rpm -ivh lame*</code></li>
</ol>
<h2>B. Build a Custom Kernel</h2>
The instructions are given in <a
 href="http://www.redhat.com/docs/manuals/linux/RHL-9-Manual/custom-guide/ch-custom-kernel.html">Redhat
Linux 9 Customization Guide</a>.<br>
<ol>
  <li>Open a terminal.</li>
  <li><code>su -</code></li>
  <li><code>cd /usr/src/linux-2.4</code></li>
  <li><code>make mrproper</code></li>
  <li><code>cp config/kernel-2.4.20-i686.config .config</code></li>
  <li><code>make xconfig</code></li>
  <li>This will bring up the Linux Kernel Configuration window. Just
click <span style="font-style: italic;">Save and Exit</span>.</li>
  <li><code>make clean</code></li>
  <li><code>make bzImage</code></li>
  <li><code>make modules</code></li>
  <li><code>make modules_install</code></li>
  <li><code>make install</code></li>
  <li>Verify that <code>/boot/initrd-2.4.20-8custom.img</code> exists</li>
  <li><code>reboot</code></li>
</ol>
<h2>C. Install V4L2</h2>
V4L2 is work in progress. So far, I've only gotten the 20030717 CVS
snapshot to work.<br>
<ol>
  <li>Download <code><a href="v4l2-20030717.tar.gz">v4l2-20030717.tar.gz</a></code>
to the home directory</li>
  <li><code>tar xvfz v4l2-20030717.tar.gz</code></li>
  <li>su</li>
  <li><code>cd v4l2</code></li>
  <li><span style="font-family: monospace;"></span><code>mv
/usr/include/linux/videodev.h /usr/include/linux/videodev.h.orig</code><code></code></li>
  <li><code>cp videodev.h /usr/include/linux</code><code></code></li>
  <li><code>cp videodev2.h /usr/include/linux</code></li>
  <li>Edit <code>Makefile</code> and change <code>depmod</code> to <code>/sbin/depmod</code></li>
  <li><code>make</code></li>
  <li><code>make install</code></li>
</ol>
<h2>D. Install New bttv Driver</h2>
<ol>
  <li>Download<code><a href="file:///home/wmohsin/v4l2-20030717.tar.gz"></a></code>
    <code><a href="bttv9-20030717.tar.gz">bttv9-20030717.tar.gz</a></code>
to the home directory</li>
  <li><code>tar xvfz bttv9-20030717.tar.gz</code><code></code></li>
  <li>su</li>
  <li><code>cd bttv-0.9.12<br>
    </code></li>
  <li>Edit <code>Makefile</code> and change <code>depmod</code> to <code>/sbin/depmod</code></li>
  <li><code>make</code></li>
  <li><code>make install</code></li>
</ol>
<h2>E. Setup modprobe to load bttv from new location</h2>
The V4L2 and bttv drivers are installed in the
/lib/modules/2.4.20-8custom/v4l2 directory. You should see a listing
similar to this:<br>
<br>
<code>-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4936 Aug&nbsp; 4
18:54 btcx-risc.o<br>
-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 113484 Aug&nbsp; 4 18:54 bttv.o<br>
-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 15616 Jul 18 10:48
v4l1-compat.o<br>
-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8084 Jul 18 10:48
v4l2-common.o<br>
-rw-r--r--&nbsp;&nbsp;&nbsp; 1 root&nbsp;&nbsp;&nbsp;&nbsp;
root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 19544 Aug&nbsp; 4 18:54
video-buf.o</code><br>
<br>
The original V4L2 and bttv drivers are installed in
/lib/modules/2.4.20-8custom/kernel/drivers/media/video.<br>
<br>
<span style="font-weight: bold;">modprobe</span> is a program which
loads/unloads <span style="font-style: italic;">loadbale kernel modules</span>
(LKMs). By default, modprobe searches for an LKM in /lib/modules/boot
before looking in /lib/modules/2.4.20-8custom. This can be verified by
using the '<code>modprobe -c</code>' command. modprobe also uses
/lib/modules/2.4.20-8custom/modules.dep for resolving module
dependencies.<br>
<br>
The bttv driver installation does not remove the original bttv.o entry
from the modules.dep file (bug ???). Since we want to load the bttv
driver (and its dependencies) from the new location
(/lib/modules/2.4.20-8custom/v4l2 directory), an easy way is to rename
the original bttv LKM and remove its entry from the modules.dep file.
The following steps do that:<br>
<ol>
  <li><code>cd /lib/modules/2.4.20-8custom/kernel/drivers/media/video</code></li>
  <li><code>mv bttv.o bttv.o.orig</code></li>
  <li><code>cd /lib/modules/2.4.20-8custom</code></li>
  <li>Edit <code>modules.dep</code> and delete <code>/lib/modules/2.4.20-8custom/kernel/drivers/media/video/bttv.o</code>
and its dependencies.<br>
  </li>
</ol>
<h2>F. Testing the Installation</h2>
<ul>
  <li><code>su -</code></li>
  <li><code>modprobe bttv</code></li>
  <li><code>modinfo bttv</code> should display something like<br>
  </li>
</ul>
<code>filename:&nbsp;&nbsp;&nbsp;
/lib/modules/2.4.20-8custom/v4l2/bttv.o<br>
description: "bttv - v4l/v4l2 driver module for bt848/878 based cards"<br>
author:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Ralph Metzler &amp; Marcus
Metzler &amp; Gerd Knorr"<br>
license:&nbsp;&nbsp;&nbsp;&nbsp; "GPL"<br>
...<br>
</code>
<ul>
  <li><code>modinfo v4l2-common</code> should display something like</li>
</ul>
<code>filename:&nbsp;&nbsp;&nbsp;
/lib/modules/2.4.20-8custom/v4l2/v4l2-common.o<br>
description: "misc helper functions for v4l2 device drivers"<br>
author:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Bill Dirks, Justin Schoeman,
Gerd Knorr"<br>
license:&nbsp;&nbsp;&nbsp;&nbsp; "GPL"</code><br>
<big></big>
</body>
</html>
